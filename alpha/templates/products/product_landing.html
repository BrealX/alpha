{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load products_tags %}
{% load avatar_tags %}

{% block header %}
    <link rel="stylesheet" href="{% static 'css/smoothproducts.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'css/star-rating.css' %}" media="all" type="text/css" />
{% endblock header %}

{% block content %}
 <section id="product_landing" class="clearfix landing-area">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-sm-6 col-sm-6">
                    <div class="landing-heading">
                        <h4>{{ product.name }}</h4>
                        <h6>{{ product.name|slice:":1" }}</h6>
                        <p>{{ product.category.description }}</p>
                    </div>
                    <div class="buy-area">
                        <form method="post" id="landing_page_form" class="form-inline" action="{% url 'add_to_cart' %}">{% csrf_token %}
                            <div class="input-group bootstrap-touchspin">
                                <input type="text" class="form-control d-none landing-quantity" id="landing_page_qnty" value="1">
                                <button type="submit" class="btn submit-btn" id="landing_page_submit_btn" data-product_id="{{ product.id }}" data-qnty="1">ЗАКАЗАТЬ</button>
                            </div>
                        </form>
                        <!-- FormEnd -->
                    </div>
                </div>
                <div class="col-sm-4 col-sm-4 landing-picture">
                    <img src="{{ product.product_main_image.image.url }}" class="landing-picture-screen img-fluid" alt="Responsive image"">
                </div>
            </div>
        </div>
    </section>
    <!-- Section -->
    <section id="landing_about" class="special-area bg-white section-padding-100">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="section-heading text-center">
                        <h2>Для кого?</h2>
                        <div class="line-shape"></div>
                    </div>
                </div>
            </div>
            <!-- rowEnd -->
            <div class="row">
                <!-- Single Special Area -->
                <div class="col-sm-4">
                    <div class="single-special text-center card" data-aos="fade-up">
                        <div class="card-body">
                            <div class="single-icon card-title">
                                <i class="ion-man"></i>
                                <i class="ion-woman"></i>
                            </div>
                            <h4 class="card-subtitle mb-2 text-muted">Пол:</h4>
                            <p class="card-text">
                                Рядом с Вами будущий певец? Или певица? Не важно! Игрушка универсальна и подходит для любого ребенка
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Single Special Area -->
                <div class="col-sm-4">
                    <div class="single-special text-center card" data-aos="fade-up">
                        <div class="card-body">
                            <div class="single-icon card-title">
                                <i class="ion-ios-time-outline"></i>
                            </div>
                            <h4 class="card-subtitle mb-2 text-muted">Возраст:</h4>
                            <p class="card-text">
                                {{ product.description_age }}
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Single Special Area -->
                <div class="col-sm-4">
                    <div class="single-special text-center card" data-aos="fade-up">
                        <div class="card-body">
                            <div class="single-icon card-title">
                                <i class="ion-music-note"></i>
                            </div>
                            <h4 class="card-subtitle mb-2 text-muted">Содержание:</h4>
                            <p class="card-text">
                                {{ product.description_content }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- rowEnd -->
            <div class="special-description-area mt-150">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-6 col-md-12 col-sm-12">
                            <div class="special-description-img sp-wrap">
                                <a href="{{ product.product_main_image.image.url }}">
                                    <img class="img-responsive" src="{{ product.product_main_image.image.url }}" alt="img">
                                </a>
                                {% for image in product.product_all_images %}
                                <a href="{{ image.image.url }}">
                                    <img class="img-responsive" src="{{ image.image.url }}" alt="img">
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12 col-sm-12">
                            <div class="special-description-content">
                                <h2 class="text-center">Лучшее предложение для Вашей маленькой звезды!</h2>
                                <p align="justify">
                                    {{ product.description }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--endContainer-->
    </section>
    <section id="landing_features" class="awesome-feature-area bg-white section-padding-0-100 clearfix">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-heading text-center">
                        <h2>Характеристики</h2>
                        <div class="line-shape"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-sm-6 col-lg-6">
                    <div class="single-feature text-center">
                        <i class="ion-cube"></i>
                        <h5>Размер упаковки:</h5>
                        <p>{{ product.description_package_size }}</p>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-6">
                    <div class="single-feature text-center">
                        <i class="ion-ios-loop"></i>
                        <h5>Размер товара:</h5>
                        <p>{{ product.description_product_size }}</p>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-6">
                    <div class="single-feature text-center">
                        <i class="ion-bag"></i>
                        <h5>Вид упаковки:</h5>
                        <p>{{ product.description_package_type }}</p>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-6">
                    <div class="single-feature text-center">
                        <i class="ion-battery-half"></i>
                        <h5>Батарейки:</h5>
                        <p>{{ product.description_battery }}</p>
                    </div>
                </div>
            </div>
            <!-- rowEnd -->
        </div>
    </section>
    <section class="cool-facts-area clearfix" id="counters">
        <div class="container">
            <div class="row">
                <!--Single Cool Fact-->
                <div class="col-12 col-md-3 col-lg-3">
                    <div class="single-cool-fact d-flex justify-content-center" data-aos="fade-up" style="min-height: 90px;">
                        <div class="cool-facts-content">
                            <i class="ion-arrow-down-a"></i>
                            <p>КОЛИЧЕСТВО ЗАКАЗОВ</p>
                        </div>
                        <div class="counter-area">
                            <h3>
                                <span class="counter" data-from="0" data-to="{{ product_order_times }}" data-speed="3000"></span>
                            </h3>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3 col-lg-3">
                    <div class="single-cool-fact d-flex justify-content-center" data-aos="fade-up" style="min-height: 90px;">
                        <div class="cool-facts-content">
                            <i class="ion-happy-outline"></i>
                            <p>ДОВОЛЬНЫХ КЛИЕНТОВ</p>
                        </div>
                        <div class="counter-area">
                            <h3>
                                <span class="counter" data-from="0" data-to="{{ happy_clients }}" data-speed="3000"></span>
                            </h3>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3 col-lg-3">
                    <div class="single-cool-fact d-flex justify-content-center" data-aos="fade-up" style="min-height: 90px;">
                        <div class="cool-facts-content">
                            <i class="ion-ios-star-outline"></i>
                            <p>СРЕДНИЙ РЕЙТИНГ</p>
                        </div>
                        <div class="counter-area">
                            <h3>
                                <span class="counter-decimal" data-from="0" data-to="4.9" data-speed="3000"></span>
                            </h3>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3 col-lg-3">
                    <div class="single-cool-fact d-flex justify-content-center" data-aos="fade-up" style="min-height: 90px;">
                        <div class="cool-facts-content">
                            <i class="ion-model-s"></i>
                            <p>ДОСТАВКА (ДНЕЙ)</p>
                        </div>
                        <div class="counter-area">
                            <h3>
                                <span class="counter" data-from="0" data-to="2" data-speed="1000"></span>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
            <!-- rowEnd -->
        </div>
    </section>
    <section id="landing_pricing" class="pricing-plane-area clearfix" style="margin-top: -100px; padding-top: 40px;">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-heading text-center">
                        <h2>Цена</h2>
                        <div class="line-shape"></div>
                    </div>
                </div>
            </div>
            <div class="row no-gutters">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="single-price-plan text-center">
                        <div class="package-plan">
                            <h5>Цена товара</h5>
                            <div class="ca-price d-flex justify-content-center">
                                <h4>{{ product.price_with_discount|floatformat }}<span> грн.</span></h4>
                            </div>
                            <div class="package-description">
                                {% if product.discount %}
                                <p>Цена УЖЕ со СКИДКОЙ</p>
                                <p>Ваша персональная скидка: {{ product.discount }} %</p>
                                <p>Обычная цена товара: {{ product.price }} грн.</p>
                                {% endif %}
                                <p>Наличие товара на складе: {% if product.is_in_stock %} В НАЛИЧИИ {% elif product.is_on_demand %} ПОД ЗАКАЗ {% else %} ОТСУТВУЕТ НА СКЛАДЕ {% endif %}</p>
                            </div>
                            <div class="plan-button">
                                <button type="submit" form="landing_page_form" class="landing-submit" data-product_id="{{ product.id }}" data-qnty="1">ЗАКАЗАТЬ!</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="testimonials" class="clients-feedback-area bg-white clearfix">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10">
                    <!-- Client Feedback Text -->
                    {% if feedbacks %}
                    <div class="owl-carousel slider">
                        {% for feedback in feedbacks %}
                        <div class="client-feedback-text">
                            <div class="client text-center">
                                <i class="fa fa-quote-left" aria-hidden="true"></i>
                            </div>
                            <div class="client-description text-center">
                                <p>
                                    {{ feedback.text|linebreaks|safe|truncatewords_html:50 }}
                                    {% ifnotequal feedback.text feedback.text|truncatewords:50 %}
                                        <!-- Button trigger modal -->
                                        <button data-username="{% if feedback.user.first_name %}{{ feedback.user.first_name }}{% else %}{{ feedback.user.username }}{% endif %}" type="button" class="btn submit-btn" data-toggle="modal" data-feedback_text="{{ feedback.text }}" data-target="#feedbackModal">Читать полностью</button>
                                    {% endifnotequal %}
                                </p>
                            </div>
                            <div class="star-icon text-center">
                                {% for item in feedback.score|times %}
                                    <i class="ion-ios-star"></i>
                                {% endfor %}
                            </div>
                            <div class="client-name text-center">
                                <h5>{% if feedback.user.first_name %}{{ feedback.user.first_name }}{% else %}{{ feedback.user.username }}{% endif %}</h5>
                            </div>
                            <div class="client-thumbnail text-center">
                                <img src="{% avatar_url feedback.user %}">
                            </div>
                            {% if user.is_authenticated and user_ordered_products and not user_product_reviews %}
                            <div class="footer-text text-center">
                                <button id="feedback_button" type="button" class="btn feedback-btn" data-toggle="modal" data-target="#addfeedbackModal">Оставить отзыв</button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <!-- End Feedback -->
                    {% else %}
                    <div class="section-heading text-center">
                        <h2>Отзывы</h2>
                            <div class="line-shape"></div>
                    </div>
                    {{ form.errors }}
                    {{ form.non_field_errors }}
                    <div class="footer-text text-center">
                        <p>К данному товару еще никто не оставлял отзывы</p>
                        {% if user.is_authenticated and not user_ordered_products %}
                        <p>Чтобы оставить отзыв, нужно сначала приобрести товар</p>
                        {% elif user.is_authenticated and user_ordered_products %}
                        <button id="feedback_button" type="button" class="btn feedback-btn" data-toggle="modal" data-target="#addfeedbackModal">Оставить отзыв</button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
    <section id="landing_contact" class="footer-contact-area section-padding-100 clearfix" style="box-shadow: rgba(0, 0, 0, 0.3) 0px 20px 30px -20px; margin-bottom: 374px; padding-top: 50px;">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="section-heading">
                        <h2>Остались вопросы?</h2>
                        <div class="line-shape"></div>
                    </div>
                    <div class="footer-text">
                        <p style="margin-bottom: 50px;">Если у Вас остались какие-либо вопросы - задавайте! Ответим максимально быстро!</p>
                    </div>
                    <div class="address-text">
                        <p>
                            <span>Адрес:</span>
                            г. Киев, Украина
                        </p>
                    </div>
                    <div class="phone-text">
                        <p>
                            <span>Телефон:</span>
                            {{ shop_tel }}
                        </p>
                    </div>
                    <div class="email-text">
                        <p>
                            <span>Email:</span>
                            {{ shop_email }}
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="contact-form">
                        <form id="landing_contact_form" action="{% url 'contact' %}" method="post">{% csrf_token %}
                            <div class="contact-input-area">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <input type="text" class="form-control" name="contact_name" id="contact_name" placeholder="Как Вас зовут?" required>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <input type="email" class="form-control" name="contact_email" id="contact_email" placeholder="Ваш Email" required>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <textarea class="form-control" name="contact_content" id="contact_content" placeholder="Ваше сообщение" cols=30 rows=4 required></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <button id="landing_contact_submit" type="submit" class="btn submit-btn">Отправить</button>
                                    </div>
                                    <div id="landing_modal_div" class="col-md-12 d-none">
                                        <p></p>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div style="clear: both;"></div>
    <!-- Modal Feedback -->
    <div class="container">
        <div class="row">
            <div class="col-lg-7 mx-auto">
                <div class="modal fade" id="feedbackModal" tabindex="-1" role="dialog" aria-labelledby="feedbackModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="feedbackModalLabel"></h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="review-form-container"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn submit-btn" data-dismiss="modal">Закрыть</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Modal Feedback -->
    <!-- Modal Add Feedback -->
    <div class="container">
        <div class="row">
            <div class="col-lg-7 mx-auto">
                <div class="modal fade" id="addfeedbackModal" tabindex="-1" role="dialog" aria-labelledby="addfeedbackModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addfeedbackModalLabel">Добавление отзыва</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="col-12">
                                    <h5 class="text-center">Пожалуйста, напишите Ваш отзыв!</h5>
                                    <div class="review-form-container">
                                        <form method="POST" action="">
                                        {% csrf_token %}
                                            <p>Товар: {{ product.name }}</p>
                                            <p>
                                                <label for="{{ form.score.id_for_label }}">{{ form.score.label }}</label>
                                                {% render_field form.score|add_class:"form-control" %}
                                            </p>
                                            <p>
                                                <label for="{{ form.text.id_for_label }}">{{ form.text.label }}</label>
                                            </p>
                                            <p>
                                                {% render_field form.text|add_class:"form-control" placeholder="Напишие отзыв здесь" %}
                                            </p>
                                            <p class="text-center">
                                                <button class="btn submit-btn" type="submit">Опубликовать</button>
                                            </p>
                                        </form>
                                    </div>
                                    <h5 class="text-center">Недавние отзывы о товаре:</h5>
                                    {% if feedbacks %}
                                    {% for feedback in feedbacks.reverse|slice:":5" %}
                                    <div class="feedback-item">
                                        <div class="row">
                                            <div class="col-lg-4">
                                                <img src="{% avatar_url feedback.user %}" class="img-fluid">
                                                <div class="user-name">
                                                    {{ feedback.user.username }}
                                                </div>
                                                <p>Добавлен: {{ feedback.created }}</p>
                                            </div>
                                            <div class="col-lg-8">
                                                <div class="rating text-left">
                                                    <div class="star-rating">
                                                        {% for item in feedback.score|times %}
                                                            <i class="ion-ios-star"></i>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                <div class="feedback-text text-left">
                                                    {{ feedback.text }}
                                                </div>
                                            </div>
                                        </div>
                                      </div>
                                    {% endfor %}
                                    {% else %}
                                    <p>На этот товар еще никто не написал отзыв. Будьте первым!</p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn submit" data-dismiss="modal">Закрыть</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    
    <!-- CountTo Plugin
    http://verstaemvse.ru/avtomaticheskij-schetchik-countto-js.html -->
    <script type="text/javascript" src="{% static 'js/jquery.countTo.js' %}"></script>

    <!-- Smoothproducts Zoomer
    https://github.com/kthornbloom/Smoothproducts -->
    <script type="text/javascript" src="{% static 'js/smoothproducts.min.js' %}"></script>

    <!-- Star Rating 
        http://plugins.krajee.com -->
    <script type="text/javascript" src="{% static 'js/star-rating.js' %}"></script>    
    <script type="text/javascript" src="{% static 'js/star-rating_locale_ru.js' %}"></script>    

    <script type="text/javascript">
        // Product Page Zoomer Initializer
        $(window).on('load', function() {
            $('.sp-wrap').smoothproducts();
        });
        // CountTo Plugin Initializer (https://stackoverflow.com/questions/43202706/jquery-counto-js-on-scroll-count-numbers-not-onload)
        function isScrolledIntoView(el) {
            if (el.getBoundingClientRect().top | el.getBoundingClientRect().bottom) {
                var elemTop = el.getBoundingClientRect().top;
                var elemBottom = el.getBoundingClientRect().bottom;

                var isVisible = (elemTop >= 0) && (elemBottom <= window.innerHeight);
                return isVisible
            }
        };
        $(window).on('scroll', function() {
            if (isScrolledIntoView(document.getElementById('counters'))) {
                $('.counter').countTo();
                $('.counter-decimal').countTo({
                    formatter: function (value, options) {
                        return value.toFixed(1);
                    }
                });
                // Unbind scroll event
                $(window).off('scroll');
            }
        });
    </script>

    <script>
        $("#id_score").rating({
            min: 0,
            max: 5,
            step: 1.0,
            size: 'sm',
        });
    </script>

    <script>
        $('#feedback_button').on('click', function() {
            var scroll_positon = $(window).scrollTop();
            localStorage.setItem('scrollPosition', scroll_positon);
        });

        $(document).ready(function() {
            $(window).scrollTop(localStorage.getItem('scrollPosition'));
            localStorage.setItem('scrollPosition', '0');
        });
    </script>

    <script>
        $('.owl-carousel').owlCarousel({
            loop:true,
            nav:false,
            autoplay:true,
            /*autoplayTimeout:3000,*/
            /*autoplayHoverPause:true,*/
            responsiveClass:true,
            responsive:{
                0:{
                    items:1,
                },
                600:{
                    items:1,
                },
                1000:{
                    items:1,
                }
            }
        })
    </script>

{% endblock %}